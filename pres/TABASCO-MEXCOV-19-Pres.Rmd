---
title: "TABASCO-MEXCOV-19"
author: "Andrea Cicchini, Rossella Marvulli, Victor Plesco"
date: "July 3, 2020"
output:
  slidy_presentation: default
---

## Index

- Introduction
- Descriptive Analysis
- Logistic Regression
- Autoregressive Model (ARIMA)

## Introduction  

### Data  

The data used within this [project](https://github.com/vrpo/TABASCO-MEXCOV-19) has been gathered from the [government of Mexico's website](https://www.gob.mx/salud/documentos/datos-abiertos-152127) and is composed of `528.651` records related to the executed swabs, having as purpose the detection of covid infections, across the states of Mexico between `2020-01-01` and `2020-06-25`. Each record specifies the **`Gender`** and **`Age`** of the unit on which the swab was executed, the **`State`** and **`Region`** in which the test was executed, the **`swab_Date`** of execution, alongside with the **`WeekDays`**, and its **`Result`**.  

```{r echo = FALSE, message = FALSE, warning = FALSE}
source("~/TABASCO-MEXCOV-19/src/packages/autoinstall.R")
source("~/TABASCO-MEXCOV-19/src/support/my_mh.R")

data <- read.csv("~/train_set.csv"); 
kable(head(data), row.names = FALSE)  %>% kable_styling(position = "center")
```

### Train, Test & Real Set  

For the testing purpose we proceed with a `80/20` split of the dataset and concentrate our analyses only on the central states of Mexico. Alongside the latter reductions we impose a temporal limit to the records (i.e. the data used for training and testing our models) which is the period in between `2020-03-07` and `2020-04-18`. Lastly we define the `Real` set, composed of the executed swabs from `2020-04-19` to `2020-06-25`, for visualizing our prediction over a longer period of time.

## Descriptive Analysis  

### Age.Labels

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
age.table <- with(data, table(Result, Age.Labels))
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
mosaicplot(t(age.table), col = c("indianred", "dodgerblue"), cex.axis = 1, sub = "", ylab = "", main = "Result by Age.Labels: Mosaic Plot")
```

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
chisq.test(age.table)
CramerV(age.table)
```

### Gender

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
data$WeekDays <- factor(data$WeekDays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"));
gender.table <- with(data, table(Result, Gender))
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
mosaicplot(t(gender.table), col = c("indianred", "dodgerblue"), cex.axis = 1, sub = "", ylab = "", main = "Result by Gender: Mosaic Plot")
```

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
chisq.test(gender.table)
CramerV(gender.table)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
doubledecker(Result ~ Age.Labels + Gender, data = data)
```

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
gender.age.table <- with(data, table(Result, Gender, Age.Labels))
with(data, my_mantelhaen.test(gender.age.table, alternative = "two.sided"))
```

### WeekDays  

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
weekdays.table <- with(data, table(Result, WeekDays))
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
mosaicplot(t(weekdays.table), col = c("indianred", "dodgerblue"), cex.axis = 1, sub = "", ylab = "", main = "Result by WeekDays: Mosaic Plot")
```

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
chisq.test(weekdays.table)
CramerV(weekdays.table)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
buffers_ts <- read.csv("~/buffers_ts.csv"); 
buffers_ts$Date <- as.Date(buffers_ts$Date, "%Y-%m-%d")
buffers_ts$WeekDays <- as.factor(weekdays(as.POSIXct(as.character(buffers_ts$Date), format = "%Y-%m-%d"), abbreviate = F));
levels(buffers_ts$WeekDays) <- c("Sunday", "Thursday", "Monday", "Tuesday", "Wednesday", "Saturday", "Friday");
buffers_ts$WeekDays <- factor(buffers_ts$WeekDays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"));

ggplot() + 
  geom_line(data = buffers_ts, aes(x = Date, y = NACIONAL), col = "black") +
  geom_point(data = buffers_ts[buffers_ts$WeekDays == "Saturday",], aes(x = Date, y = NACIONAL), col = "dodgerblue", size = 2.5) +
  geom_point(data = buffers_ts[buffers_ts$WeekDays == "Sunday",], aes(x = Date, y = NACIONAL), col = "indianred2", size = 2.5) +
  
  ## Custom Label
  labs(title = "Daily Confirmed Cases: Saturdays and Sundays",
       subtitle = "",
       x = "Date",
       y = "Daily Confirmed") +
  theme_bw(base_size = 15, base_family = "Times") +
  
  geom_text(aes(x = as.Date("2020-01-28", "%Y-%m-%d"), y = 5000), label = "Saturday", size = 3) +
  geom_point(aes(x = as.Date("2020-01-21", "%Y-%m-%d"), y = 5000), col = "dodgerblue", size = 3) + 
  
  geom_text(aes(x = as.Date("2020-01-28", "%Y-%m-%d"), y = 4700), label = "Sunday", size = 3) +
  geom_point(aes(x = as.Date("2020-01-21", "%Y-%m-%d"), y = 4700), col = "indianred", size = 3)
```

### State

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
state.table <- with(data, table(Result, State))
```

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
chisq.test(state.table)
CramerV(state.table)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
ggplot() + 
  
  geom_bar(data = data, aes(x = State, fill = Result)) +
  
  ## Custom Label
  labs(title = "Histogram of State per Result",
       subtitle = "",
       x = "State",
       y = "Count") +
  theme_bw(base_size = 15, base_family = "Times") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  scale_fill_manual(values = c("indianred", "dodgerblue"))
```
  
## Logistic Regression  

### Model Evaluation  

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
train_set <- read.csv("~/TABASCO-MEXCOV-19/pres/data/classification/train_set.csv")
test_set  <- read.csv("~/TABASCO-MEXCOV-19/pres/data/classification/test_set.csv")
real_set  <- read.csv("~/TABASCO-MEXCOV-19/pres/data/classification/real_set.csv")

train_set$dConfirmed <- as.Date(train_set$dConfirmed, "%Y-%m-%d");
test_set$dConfirmed  <- as.Date(test_set$dConfirmed, "%Y-%m-%d");
real_set$dConfirmed  <- as.Date(real_set$dConfirmed, "%Y-%m-%d");
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
train_set$WeekDays <- factor(train_set$WeekDays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"));
train_set$Result <- factor(train_set$Result, levels = c("Negative", "Positive"));
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
glm.logit.fit4 <- glm(Result ~ Age.Labels + Gender + WeekDays + State, family = binomial(link = "logit"), data = train_set)
summary(glm.logit.fit4)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
glm.logit.fit1 <- glm(Result ~ Age.Labels, family = binomial(link = "logit"), data = train_set)
glm.logit.fit2 <- glm(Result ~ Age.Labels + Gender, family = binomial(link = "logit"), data = train_set)
glm.logit.fit3 <- glm(Result ~ Age.Labels + Gender + WeekDays, family = binomial(link = "logit"), data = train_set)
```

#### Anova

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
anova(glm.logit.fit1, glm.logit.fit2, glm.logit.fit3, glm.logit.fit4, test = "Chisq")
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", , results = "hide", fig.align = "center", fig.height = 5, fig.width = 10}
tmp <- list(model1 = pscl::pR2(glm.logit.fit1)["McFadden"],
            model2 = pscl::pR2(glm.logit.fit2)["McFadden"],
            model3 = pscl::pR2(glm.logit.fit3)["McFadden"],
            model4 = pscl::pR2(glm.logit.fit4)["McFadden"]);
RMcFadden <- data.frame(Model1 = as.numeric(tmp[1]),
                        Model2 = as.numeric(tmp[2]),
                        Model3 = as.numeric(tmp[3]),
                        Model4 = as.numeric(tmp[4]));
colnames(RMcFadden) <- c("Model 1", "Model 2", "Model 3", "Model 4");
rownames(RMcFadden)[1] <- "McFadden";
```

#### McFadden

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
RMcFadden
```

#### ROC Curve

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 10, fig.width = 10}
cutoff <- seq(0.01, 1, 0.01);
indexes <- data.frame(Sensitivity = rep(NA, length(cutoff)),
                      Specificity = rep(NA, length(cutoff)),
                      Accuracy    = rep(NA, length(cutoff)))
glm.logit.predict <- as.vector(predict(glm.logit.fit4, newdata = train_set, type = "response")); 
tmp <- train_set$Result;
for(i in 1:length(cutoff))
{
  predicted.classes <- as.factor(ifelse(glm.logit.predict > cutoff[i], "Positive", "Negative")); 
  tmp2 = confusionMatrix(data = predicted.classes, reference = tmp, positive = "Positive");
  
  indexes$Sensitivity[i] = as.numeric(tmp2$byClass[1]);
  indexes$Specificity[i] = as.numeric(tmp2$byClass[2]);
  indexes$Accuracy[i]    = as.numeric(tmp2$overall[1]);
  indexes$Precision[i]   = as.numeric(tmp2$byClass[5]);
}

indexes$Optimal <- indexes$Sensitivity - indexes$Specificity;
  
ggplot() + 
  
  ## Sensitivity
  geom_line(aes(x = cutoff, y = indexes$Sensitivity), col = "indianred") +
  
  ## Specificity
  geom_line(aes(x = cutoff, y = indexes$Specificity), col = "black") +
  
  ## Accuracy
  geom_line(aes(x = cutoff, y = indexes$Accuracy), col = "dodgerblue") +
           
  ## Cut-off
  geom_point(aes(x = cutoff[which(abs(indexes$Optimal) == min(abs(indexes$Optimal), na.rm = TRUE))] + 0.005, 
                 y = indexes$Sensitivity[which(abs(indexes$Optimal) == min(abs(indexes$Optimal), na.rm = TRUE))] - 0.006), 
                      col = "black",
                      size = 3) +
           
  ## Custom Label
  labs(title = "ROC Curve",
      subtitle = "",
      x = "Cut-off",
      y = "Classification Metric") +
  theme_bw(base_size = 15, base_family = "Times") +

  ## Custom Labels
  
  geom_text(aes(x = 0.83, y = 0.375),  label = "Sensitivity", size = 5) +
  geom_line(aes(x = seq(0.735, 0.765, length = 10), y = rep(0.375, length(seq(0.735, 0.765, length = 10)))), col = "indianred", size = 2) +
  
  geom_text(aes(x = 0.83, y = 0.35), label = "Specificity",    size = 5) +
  geom_line(aes(x = seq(0.735, 0.765, length = 10), y = rep(0.35, length(seq(0.735, 0.765, length = 10)))), col = "black", size = 2) +
  
  geom_text(aes(x = 0.83, y = 0.325), label = "Accuracy",    size = 5) +
  geom_line(aes(x = seq(0.735, 0.765, length = 10), y = rep(0.325, length(seq(0.735, 0.765, length = 10)))), col = "dodgerblue", size = 2)
```

### Prediction

#### Test Set

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 7.5, fig.width = 10}
glm.logit.predict <- as.vector(predict(glm.logit.fit4, newdata = test_set, type = "response")); 
predicted.classes <- as.factor(ifelse(glm.logit.predict > cutoff[which(abs(indexes$Optimal) == min(abs(indexes$Optimal), na.rm = TRUE))], "Positive", "Negative")); tmp <- test_set$Result;
confusionMatrix(data = predicted.classes, reference = tmp, positive = "Positive")
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 7.5, fig.width = 10}
dIndex <- data.frame(Date = unique(test_set$dConfirmed),
                     Confirmed = rep(NA, length(unique(test_set$dConfirmed))))
minDate <- c()
for(i in 1:nrow(dIndex)) {minDate[i] = min(which(test_set$dConfirmed == dIndex[i, 1]))}
maxDate <- c()
for(i in 1:nrow(dIndex)) {maxDate[i] = max(which(test_set$dConfirmed == dIndex[i, 1]))}
for(i in 1:nrow(dIndex))
{
  tmp = as.data.frame(test_set %>% filter(test_set$dConfirmed == dIndex[i, 1] & test_set$Region == "Center") %>%
                        select(Age.Labels, Gender, Region, WeekDays, Result, State));
  glm.logit.predict = as.vector(predict(glm.logit.fit4, newdata = tmp[, -5], type = "response")); 
  tmp2 = as.factor(ifelse(glm.logit.predict > cutoff[which(abs(indexes$Optimal) == min(abs(indexes$Optimal), na.rm = TRUE))], "Positive", "Negative"));
  dIndex[i, 2] = confusionMatrix(data = tmp2, reference = tmp$Result)$table[2, 2]; 
}

tmp <- as.data.frame(test_set %>% group_by(dConfirmed) %>% summarise(COUNT = n()))


ggplot() + 
  geom_line(data = tmp, aes(x = dConfirmed, y = COUNT), col = "red2") +
  geom_line(data = dIndex, aes(x = Date, y = Confirmed), col = "black") +
  
  ## Custom Label
  labs(title = "Prediction of daily confirmed cases: Logistic Regression",
       subtitle = "",
       x = "Date",
       y = "Daily Confirmed") +
  theme_bw(base_size = 15, base_family = "Times")
```

#### Real Set

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 7.5, fig.width = 10}
glm.logit.predict <- as.vector(predict(glm.logit.fit4, newdata = real_set, type = "response")); 
predicted.classes <- as.factor(ifelse(glm.logit.predict > cutoff[which(abs(indexes$Optimal) == min(abs(indexes$Optimal), na.rm = TRUE))], "Positive", "Negative")); tmp <- real_set$Result;
confusionMatrix(data = predicted.classes, reference = tmp, positive = "Positive")
```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 7.5, fig.width = 10}
dIndex <- data.frame(Date = unique(real_set$dConfirmed),
                     Confirmed = rep(NA, length(unique(real_set$dConfirmed))))
minDate <- c()
for(i in 1:nrow(dIndex)) {minDate[i] = min(which(real_set$dConfirmed == dIndex[i, 1]))}
maxDate <- c()
for(i in 1:nrow(dIndex)) {maxDate[i] = max(which(real_set$dConfirmed == dIndex[i, 1]))}
for(i in 1:nrow(dIndex))
{
  tmp = as.data.frame(real_set %>% filter(real_set$dConfirmed == dIndex[i, 1] & real_set$Region == "Center") %>%
                        select(Age.Labels, Gender, Region, WeekDays, Result, State));
  glm.logit.predict = as.vector(predict(glm.logit.fit4, newdata = tmp[, -5], type = "response")); 
  tmp2 = as.factor(ifelse(glm.logit.predict > cutoff[which(abs(indexes$Optimal) == min(abs(indexes$Optimal), na.rm = TRUE))], "Positive", "Negative"));
  dIndex[i, 2] = confusionMatrix(data = tmp2, reference = tmp$Result)$table[2, 2]; 
}

tmp <- as.data.frame(real_set %>% group_by(dConfirmed) %>% summarise(COUNT = n()))


ggplot() + 
  geom_line(data = tmp, aes(x = dConfirmed, y = COUNT), col = "red2") +
  geom_line(data = dIndex, aes(x = Date, y = Confirmed), col = "black") +
  
  ## Custom Label
  labs(title = "Prediction of daily confirmed cases: Logistic Regression",
       subtitle = "",
       x = "Date",
       y = "Daily Confirmed") +
  theme_bw(base_size = 15, base_family = "Times")
```


```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
train_set <- read.csv("~/TABASCO-MEXCOV-19/pres/data/arima/train_set.csv", header = TRUE)
test_set  <- read.csv("~/TABASCO-MEXCOV-19/pres/data/arima/test_set.csv", header = TRUE)
real_set  <- read.csv("~/TABASCO-MEXCOV-19/pres/data/arima/real_set.csv", header = TRUE)

train_set$Date <- as.Date(train_set$Date, "%Y-%m-%d")
test_set$Date <- as.Date(test_set$Date, "%Y-%m-%d")
real_set$Date <- as.Date(real_set$Date, "%Y-%m-%d")

ts_d_train <- ts(train_set[, c("dTotal")], frequency = 7)
ts_a_train <- ts(train_set[, c("aTotal")], frequency = 7);

dtf_all <- data.frame(rbind(train_set, test_set))
ts_d_all <- ts(dtf_all$dTotal, frequency = 7) 
ts_a_all <- ts(dtf_all$aTotal, frequency = 7)
```

## Autoregressive Model (ARIMA)

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
intro <- rbind(train_set, test_set, real_set);

ggplot() + 
  
  geom_line(data = intro, aes(x = Date, y = dTotal), col = "red2") +
  
  geom_line(aes(x = rep(as.Date("2020-03-08", "%Y-%m-%d"), 2), y = c(1, 7000)), col = "black", linetype = "dashed") +
  geom_line(aes(x = rep(as.Date("2020-04-10", "%Y-%m-%d"), 2), y = c(1, 7000)), col = "black", linetype = "dashed") +
  geom_line(aes(x = rep(as.Date("2020-04-18", "%Y-%m-%d"), 2), y = c(1, 7000)), col = "black", linetype = "dashed") +

  geom_text(aes(x = as.Date("2020-03-22", "%Y-%m-%d"), y = 4000),  label = "Train Set", size = 4) +
  geom_text(aes(x = as.Date("2020-04-14", "%Y-%m-%d"), y = 4000),  label = "Test Set",  size = 4) +

  ## Custom Label
  labs(title = "Daily Confirmed Cases",
       subtitle = "",
       x = "Date",
       y = "Daily Confirmed") +
  theme_bw(base_size = 15, base_family = "Times")

ggplot() + 
  
  geom_line(data = intro, aes(x = Date, y = aTotal), col = "red2") +
  
  geom_line(aes(x = rep(as.Date("2020-03-08", "%Y-%m-%d"), 2), y = c(1, 400000)), col = "black", linetype = "dashed") +
  geom_line(aes(x = rep(as.Date("2020-04-10", "%Y-%m-%d"), 2), y = c(1, 400000)), col = "black", linetype = "dashed") +
  geom_line(aes(x = rep(as.Date("2020-04-18", "%Y-%m-%d"), 2), y = c(1, 400000)), col = "black", linetype = "dashed") +

  geom_text(aes(x = as.Date("2020-03-22", "%Y-%m-%d"), y = 250000),  label = "Train Set", size = 4) +
  geom_text(aes(x = as.Date("2020-04-14", "%Y-%m-%d"), y = 250000),  label = "Test Set",  size = 4) +

  ## Custom Label
  labs(title = "Cumulative Confirmed Cases",
       subtitle = "",
       x = "Date",
       y = "Cumulative Cases") +
  theme_bw(base_size = 15, base_family = "Times")
```

## STATIONARITY of TIME SERIES

- Stationary time series $\longmapsto$ statistical moments until a certain order are time-independent

- Non-stationary time series $\longmapsto$ statistical moments depend on time

Two way to detect the (non) stationarity:

- ACF and PACF

- Box-Ljung Test

## ACF and PACF

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 10, fig.width = 10}
par(mfrow = c(2,2))
acf(ts_a_train, main = 'ACF aggregated')
pacf(ts_a_all, main = 'PACF aggregated')

acf(ts_d_all, main = 'ACF daily')
pacf(ts_d_all, main = 'PACF daily')
par(mfrow = c(1,1))
```

## BOX-LJUNG TEST

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
Box.test(ts_a_train, type = "Ljung-Box")
Box.test(ts_d_train, type = "Ljung-Box")
```

## AR(p): Auto-Regression of order p

Autoregression of the evolving variable on its own lagged values: given a time series $(X_{t})_{t}$, there exist an integer p and real coefficients $\alpha_1, \alpha_2, ..., \alpha_p$ such that

$$
X_{t}= \mu + \alpha_1X_{t-1}+ ...+ \alpha_pX_{t-p}+ \epsilon_t, \quad t=1,2,....
$$
The parameter $\alpha_i$ is the partial autocorrelation at lag $i$.

## MA(q): Moving Average of order q

There exist a parameter $q$ and real coefficients $b_1, ...b_q$ such that  

$$
X_{t}= \mu_t + \epsilon_t + b_1\epsilon_{t-1}+ ...+ b_q\epsilon_{t-q}
$$
where $\epsilon_1, \epsilon_2, ... \epsilon_q$ are independent random normal variables, all with mean 0.

## ARIMA Parameters

$\bullet \quad$ If the TS is non-seasonal

$ARIMA(p,d,q)$

- $p$ = order of autoregression part
- $d$ = order of the first differencing involved
- $q$ = order of moving average part

$\bullet \quad$ If ARIMA is seasonal

$ARIMA(p,d,q)(p',d',q')_{freq}$

$p'$,$d'$,$q'$ are referred to the seasonal part of the time series.

## DECOMPOSITION OF THE AGGREGATED SET  

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
dec_a_train <- decompose(ts_a_train, "multiplicative")
plot(dec_a_train)
boxplot(ts_a_train~cycle(ts_a_train),xlab="Time")
```

## DECOMPOSITION OF THE DAILY SET  

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
dec_d_train <- decompose(ts_d_train, "multiplicative");
plot(dec_d_train)
boxplot(ts_d_train~cycle(ts_d_train),xlab="Time")

```

## AUTORIMA 

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
param_a <- auto.arima(ts_a_all, trace = TRUE, stepwise=FALSE, approximation = FALSE, method = "CSS-ML")

```


```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
param_a
```

## A MANUAL TRY: diff()

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
difftry <- diff(ts_a_train, lag=2,  differences=2)
plot(difftry)

```

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}

par(mfrow=c(1,2))
acf(ts_a_train)
acf(difftry)

```

## ARIMA for Aggregated Data

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}

arima_a.fit <- Arima(ts_a_train, order= c(1,2,3), method = "ML", include.drift = FALSE)
arima_a.fit
```

## Residuals Analysis for Aggregated Data

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
  
 arima_a.fit %>% residuals() %>% checkresiduals()

  
Box.test(arima_a.fit$resid, type="Ljung-Box")

``` 

## FORECAST of Aggregated Data

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}

predict.fit <- forecast(arima_a.fit, level = c(95), h = 8)
```


```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}

predict.fit <- forecast(arima_a.fit, level = c(95), h = 8)

ggplot() +
  
  # Reality;
  geom_line(aes(x = dtf_all$Date, y = dtf_all$aTotal), col = "black") +
  
  # Prediction;
  geom_line(aes(x = test_set$Date[1:8], y = predict.fit$lower), col = "gray", linetype = "dashed") +
  geom_line(aes(x = test_set$Date[1:8], y = predict.fit$upper), col = "gray", linetype = "dashed") +
  geom_line(aes(x = test_set$Date[1:8], y = predict.fit$mean), col = "red2") +
  
  # Confidence;
  geom_ribbon(aes(x = test_set$Date[1:8], ymin = predict.fit$lower, ymax = predict.fit$upper), fill = "gray", alpha = 0.2) +
  
  ## Custom Label
  labs(title = "Prediction of cumulative confirmed cases: ARIMA",
       subtitle = "",
       x = "Date",
       y = "Cumulative Confirmed") +
  theme_bw(base_size = 10, base_family = "Times")
```

### AGGREGATED vs DAILY

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
par(mfrow = c(1,2))
plot(ts_a_train)
plot(ts_d_train)
par(mfrow = c(1,1))
```

## AUTOARIMA for Daily Data
 
```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10} 
param_d <- auto.arima(ts_d_all, stepwise = FALSE, approximation = FALSE, method = "CSS-ML")
param_d 
```

## ARIMA for Daily Data

```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
arima_d.fit <- Arima(ts_d_train, order = c(1, 1, 2), seasonal = c(2, 0, 0), method = "ML", include.drift = FALSE)
arima_d.fit
```

## Residual Analysis for Daily Data

```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}

arima_d.fit %>% residuals() %>% checkresiduals()

Box.test(arima_d.fit$resid, type = "Ljung-Box")
```
 
## FORECAST for Daily Data
 
```{r echo = TRUE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
predict.fit <- forecast(arima_d.fit, level = c(95), h = 8)
```
 
```{r echo = FALSE, warning = FALSE, message = FALSE, comment = "", fig.align = "center", fig.height = 5, fig.width = 10}
ggplot() +
  
  # Reality;
  geom_line(aes(x = dtf_all$Date, y = dtf_all$dTotal), col = "black") +
  
  # Prediction;
  geom_line(aes(x = test_set$Date[1:8], y = predict.fit$lower), col = "gray", linetype = "dashed") +
  geom_line(aes(x = test_set$Date[1:8], y = predict.fit$upper), col = "gray", linetype = "dashed") +
  geom_line(aes(x = test_set$Date[1:8], y = predict.fit$mean),  col = "red2") +
  
  # Confidence;
  geom_ribbon(aes(x = test_set$Date[1:8], ymin = predict.fit$lower, ymax = predict.fit$upper), fill = "gray", alpha = 0.2) +
  
  ## Custom Label
  labs(title = "Prediction of daily confirmed cases: ARIMA",
       subtitle = "",
       x = "Date",
       y = "Daily Confirmed") +
  theme_bw(base_size = 10, base_family = "Times")
```